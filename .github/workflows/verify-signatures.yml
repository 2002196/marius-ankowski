name: Verify signatures

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Configure git SSH signature verification
        shell: bash
        run: |
          set -euo pipefail
          test -f allowed_signers.example
          git config --global gpg.format ssh
          git config --global gpg.ssh.allowedSignersFile "$GITHUB_WORKSPACE/allowed_signers.example"

      - name: Verify tag or commit
        shell: bash
        run: |
          set -euo pipefail
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            tag="${GITHUB_REF#refs/tags/}"
            ttype="$(git cat-file -t "$tag")"
            echo "tag=$tag type=$ttype"
            if [[ "$ttype" != "tag" ]]; then
              echo "::error::Tag $tag is lightweight (type=$ttype). Use: git tag -s $tag -m \"$tag\""
              exit 1
            fi
            git verify-tag "$tag"
          else
            git verify-commit HEAD
          fi
