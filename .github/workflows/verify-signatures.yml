name: Verify signatures

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  release:
    types: [ published ]

permissions:
  contents: read

jobs:
  verify_git:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Configure git SSH signature verification
        shell: bash
        run: |
          set -euo pipefail
          test -f allowed_signers.example
          git config --global gpg.format ssh
          git config --global gpg.ssh.allowedSignersFile "$GITHUB_WORKSPACE/allowed_signers.example"

      - name: Verify tag or commit (A)
        shell: bash
        run: |
          set -euo pipefail
          echo "GITHUB_REF=$GITHUB_REF"
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            tag="${GITHUB_REF#refs/tags/}"
            ttype="$(git cat-file -t "$tag")"
            echo "tag=$tag type=$ttype"
            [[ "$ttype" == "tag" ]] || { echo "::error::Tag $tag is lightweight (type=$ttype). Use ./tools/rtag.sh $tag \"$tag\""; exit 1; }
            git verify-tag "$tag"
          else
            git verify-commit HEAD
          fi

  verify_release_assets:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      TAG: ${{ github.event.release.tag_name }}
      REPO: ${{ github.repository }}
    steps:
      - name: Ensure gh is available
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y gh
          fi

      - name: Download release assets + verify (B)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dl
          gh release download "$TAG" --repo "$REPO" -D dl \
            -p "SHA256SUMS" -p "SHA256SUMS.sig" -p "allowed_signers.example" \
            -p "*.tar.gz" -p "*.zip"
          cd dl
          ssh-keygen -Y verify -f allowed_signers.example \
            -I "mariusankowski@gmail.com" -n "mi-release" \
            -s SHA256SUMS.sig < SHA256SUMS
          sha256sum -c SHA256SUMS
