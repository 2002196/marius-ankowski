name: Verify signatures

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]

permissions:
  contents: read

jobs:
  verify_git:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Force-fetch all tags (ensure annotated tag objects exist)
        shell: bash
        run: |
          set -euo pipefail
          git fetch --force --tags origin

      - name: Configure git SSH signature verification
        shell: bash
        run: |
          set -euo pipefail
          test -f allowed_signers.example
          git config --global gpg.format ssh
          git config --global gpg.ssh.allowedSignersFile "$GITHUB_WORKSPACE/allowed_signers.example"

      - name: Verify tag or commit (A)
        shell: bash
        run: |
          set -euo pipefail
          echo "GITHUB_REF=$GITHUB_REF"

          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            tag="${GITHUB_REF#refs/tags/}"

            # IMPORTANT: verify tag-object, not the ref (ref may look like commit in CI)
            if git rev-parse -q --verify "${tag}^{tag}" >/dev/null; then
              git verify-tag "$tag"
            else
              echo "::error::Tag $tag is lightweight (or tag-object missing). Use: ./tools/rtag.sh $tag \"$tag\""
              exit 1
            fi
          else
            git verify-commit HEAD
          fi

  verify_release_assets:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [verify_git]
    steps:
      - name: Verify release assets (B)
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          repo="${GITHUB_REPOSITORY}"
          tag="${GITHUB_REF#refs/tags/}"

          tmp="$(mktemp -d)"
          cd "$tmp"

          gh release download "$tag" --repo "$repo" \
            -p "SHA256SUMS" -p "SHA256SUMS.sig" -p "allowed_signers.example" \
            -p "*.tar.gz" -p "*.zip"

          ssh-keygen -Y verify -f allowed_signers.example \
            -I "mariusankowski@gmail.com" -n "mi-release" \
            -s SHA256SUMS.sig < SHA256SUMS

          sha256sum -c SHA256SUMS
