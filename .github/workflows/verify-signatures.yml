name: Verify signatures

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]

permissions:
  contents: read

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Force-fetch all tags (ensure annotated tag objects exist)
        shell: bash
        run: |
          set -euo pipefail
          git fetch --force --tags origin

      - name: Configure git SSH signature verification
        shell: bash
        run: |
          set -euo pipefail
          test -f allowed_signers.example
          git config --global gpg.format ssh
          git config --global gpg.ssh.allowedSignersFile "$GITHUB_WORKSPACE/allowed_signers.example"

      - name: Verify tag or commit (A: warn+skip lightweight tags)
        shell: bash
        run: |
          set -euo pipefail
          echo "GITHUB_REF=$GITHUB_REF"

          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            tag="${GITHUB_REF#refs/tags/}"
            ttype="$(git cat-file -t "$tag")"
            echo "tag=$tag type=$ttype"

            if [[ "$ttype" != "tag" ]]; then
              echo "::warning::Tag $tag is lightweight or tag object missing (type=$ttype). Skipping verify-tag."
              exit 0
            fi

            git verify-tag "$tag"
          else
            git verify-commit HEAD
          fi

      - name: Verify release assets (B: SHA256SUMS.sig + sha256sum -c)
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          tag="${GITHUB_REF#refs/tags/}"

          for i in {1..24}; do
            if gh release view "$tag" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
              break
            fi
            sleep 5
          done

          if ! gh release view "$tag" --repo "$GITHUB_REPOSITORY" >/dev/null 2>&1; then
            echo "::warning::Release $tag not found yet. Skipping asset verification."
            exit 0
          fi

          rm -rf _rel && mkdir -p _rel
          gh release download "$tag" --repo "$GITHUB_REPOSITORY" --dir _rel

          test -f _rel/SHA256SUMS
          test -f _rel/SHA256SUMS.sig

          if [[ -f _rel/allowed_signers.example ]]; then
            allowed="_rel/allowed_signers.example"
          else
            allowed="allowed_signers.example"
            echo "::warning::allowed_signers.example not present in release assets; using repo copy."
          fi

          ssh-keygen -Y verify -f "$allowed"             -I "mariusankowski@gmail.com" -n "mi-release"             -s _rel/SHA256SUMS.sig < _rel/SHA256SUMS

          ( cd _rel && sha256sum -c SHA256SUMS )
