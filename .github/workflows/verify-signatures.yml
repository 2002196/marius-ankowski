name: Verify signatures

on:
  push:
    branches: ["**"]
    tags: ["**"]
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure SSH signature verification (allowed signers from repo)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.config/git"
          cp allowed_signers.example "$HOME/.config/git/allowed_signers"
          git config --global gpg.format ssh
          git config --global gpg.ssh.allowedSignersFile "$HOME/.config/git/allowed_signers"

      - name: Verify commit signatures
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.event.pull_request.head.sha }}"
            range="$base..$head"
          else
            before="${{ github.event.before }}"
            head="${{ github.sha }}"
            if [[ "$before" == "0000000000000000000000000000000000000000" || -z "$before" ]]; then
              range="$head"
            else
              range="$before..$head"
            fi
          fi

          echo "Range: $range"
          commits="$(git rev-list --no-merges "$range" || true)"
          [[ -n "${commits:-}" ]] || { echo "No commits to verify."; exit 0; }

          while read -r sha; do
            [[ -n "$sha" ]] || continue
            echo "verify-commit $sha"
            git verify-commit "$sha"
          done <<< "$commits"

      - name: Verify tag signature (only on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF#refs/tags/}"
          echo "verify-tag $tag"
          git verify-tag "$tag"
